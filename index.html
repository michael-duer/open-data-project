<!doctype html>
<html>
<head>
    <title>Home</title>
        <link rel="stylesheet" href="/stylesheet.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
      
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <!--<script src="/script.js"></script>-->
        
        <meta name="viewport" content="width=device-width, maximum-scale=0.5" />
    
    
<body>

    <script>
    var january2019 = "./data/january2019.csv";
    var february2019 = "test-month.csv";
    var march2019 = "./data/january2020.csv";
    var april2019 = "test2.csv";
    var may2019 = "test2.csv";
    var june2019 = "test2.csv";
    var july2019 = "test2.csv";
    var august2019 = "test2.csv";
    var september2019 = "test2.csv";
    var october2019 = "test2.csv";
    var november2019 = "test2.csv";
    var december2019 = "test2.csv";
    var year2019 = "./data/real-test.csv";

    var january2020 = "./data/january2020.csv";
    var february2020 = "test-month2.csv";
    var march2020 = "./data/january2020.csv";
    var april2020 = "test.csv";
    var may2020 = "test.csv";
    var june2020 = "test.csv";
    var july2020 = "test.csv";
    var august2020 = "test.csv";
    var september2020 = "test.csv";
    var october2020 = "test.csv";
    var november2020 = "test.csv";
    var december2020 = "test.csv";
    var year2020 = "./data/real-test2.csv";
    </script>

<div class="visualisation">

    <svg id="bar-chart" width="1200" height="700"></svg>

    <div class="bttn-box">
        <div class="month-bttn">
            <button onclick="update(january2019,january2020)">Januar</button>
            <button onclick="update(february2019,february2020)">Februar</button>
            <button onclick="update(march2019,march2020)">März</button>
            <button onclick="update(april2019,april2020)">April</button>
            <button onclick="update(may2019,may2020)">Mai</button>
            <button onclick="update(june2019,june2020)">Juni</button>
            <button onclick="update(july2019,july2020)">Juli</button>
            <button onclick="update(august2019,august2020)">August</button>
            <button onclick="update(september2019,september2020)">September</button>
            <button onclick="update(october2019,october2020)">Oktober</button>
            <button onclick="update(november2019,november2020)">November</button>
            <button onclick="update(december2019,december2020)">Dezember</button>
        </div>
        <div class="year-bttn">
            <button onclick="update(year2019,year2020)">Gesammtjahresvergleich</button>
        </div>
    </div>
</div>
<script>
    var svg = d3.select("svg"),
        margin = 200,
        width = svg.attr("width") - margin,
        height = svg.attr("height") - margin -100

    svg.append("text")
       .attr("transform", "translate(100,0)")
       .attr("x", 50)
       .attr("y", 50)
       .attr("font-size", "30px")
       .text("Fahrgastzahlen")

       var g = svg.append("g")
               .attr("transform", "translate(" + 100 + "," + 100 + ")");

    //initialize X-axis
    var xScale = d3.scaleBand().range([0, width]).padding(0.4)
    var xAxis = svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(" + 100 + "," + 500 + ")");
    xAxis = d3.axisBottom(xScale); //new try
    //initialize Y-axis
    var yScale = d3.scaleLinear().range([height, 0]);
    var yAxis = svg.append("g")
        .attr("class", "y axis");

    yAxis = d3.axisLeft(yScale);//.ticks(10); //new try to scale right
    // function to update the chart with new data
function update(month2019, month2020) {
    
    // Parse the Data
    d3.queue()
        .defer(d3.csv, month2019) //2019
        .defer(d3.csv, month2020) //2020
        .defer(d3.csv, "massnahmen.csv")
        .await(function(error, data2019, data2020, massnahmen) {
            if (error) throw error;   
    
    // X axis
    xScale.domain(data2019.map(function(d) { return d.date; }))
  //  xScale.domain([d3.min(data2019, function(d) { return d.date; }), d3.max(data2019, function(d) { return d.date; })]);
    
    // y axis
    yScale.domain([0, d3.max(data2019, function(d) { return d.transported_people; })]);
     
    //update xAxis
    svg.select(".x.axis")
        .transition()
        .duration(1000)
        .call(xAxis)
        .call(d3.axisBottom(xScale)
            .tickFormat((d) => {
                var delimiter = d.split(".");
                var d1 = new Date(Number(delimiter[2]), Number(delimiter[1]) -1, Number(delimiter[0]));
                return d3.timeFormat("%d.%m")(d1)
            }));
    //Update yAxis
    svg.select(".y.axis")
        .attr("transform", "translate(" + 100 + "," + 100 + ")")
        .transition()
        .duration(1000)
        .call(d3.axisLeft(yScale).tickFormat(function(d){
            return d;
        })
        .ticks(10))
        //delete y-axis
        .call(g => g.select(".domain")
        .remove());
    
      //delete old bars
      g.selectAll(".bar")
            .transition()
            .duration(500)
            .attr("y", 400)
            .attr("height", 0)
            .remove();

        //delete old circle
        g.selectAll("circle")
            .transition()
            .duration(500)
            .attr("r", 0)
            .remove();
    
        //delete old text
        g.selectAll("text")
            .remove();

        //delete textbox
        g.selectAll(".textBox")
            .transition()
            .duration(500)
            .attr("y", 800)
            .attr("height", 0)
            .remove();

        //delete old line from box to point
        g.selectAll("line")
            .remove();
        
        //delete polygon
        g.selectAll("polygon")
         //   .transition()
         //   .duration(500)
            .remove();
    
        // update bars2019
       g
        .selectAll("bar2019")
        .data(data2019)
        .enter()
        .append("rect")
        .on("mouseover", onMouseOver)                  
        .on("mouseout", onMouseOut)
        .attr("class", "bar")
        .attr("id", 'bar2019')
        .attr("y", height)
        .attr("x", function(d) { return xScale(d.date);})
        .attr("height", 0)
        .transition()
        .duration(1000)
        .attr("x", function(d) { return xScale(d.date); })
        .attr("y", function(d) { return yScale(d.transported_people); })
        .attr("width", xScale.bandwidth() -5)
        .attr("height", function(d) { return height - yScale(d.transported_people); });
    
        // update bars2020
        g
        .selectAll("bar2020")
        .data(data2020)
        .enter()
        .append("rect")
        .on("mouseover", onMouseOver)                  
        .on("mouseout", onMouseOut)
        .attr("class", "bar")
        .attr("id", 'bar2020')
        .attr("y", height)
        .attr("x", function(d) { return xScale(d.date);})
        .attr("height", 0)
        .transition()
        .duration(1000)
        .attr("x", function(d) { return xScale(d.date) + 10; })
        .attr("y", function(d) { return yScale(d.transported_people); })
        .attr("width", xScale.bandwidth() -5)
        .attr("height", function(d) { return height - yScale(d.transported_people); });
        

        //ersteut 2 kreise dr erst aus umrandig vom 2.
   /*     g.selectAll("g")
         .data(massnahmen)
         .enter().append("circle")
         .attr("class", "circle")
         .attr("r", 7)
         .attr("cx", function(d) { return xScale(d.date) + 10; })
         .attr("cy", 400)
         .style('fill', "#100f");

         g.selectAll("g")
         .data(massnahmen)
         .enter().append("circle")
         .attr("class", "circle")
         .attr("r", 6)
         .attr("cx", function(d) { return xScale(d.date) + 10; })
         .attr("cy", 400)
         .style('fill', "#ffff")
         .style('opacity', 1);

         g.append("line")//making a line for legend
        .data(massnahmen)
        .lower()
        .attr("x1", function(d) { return xScale(d.date) + 10; })
        .attr("x2", function(d) { return xScale(d.date) + 10; })
        .attr("y1", 400)
        .attr("y2", 450)
        .style("stroke-dasharray","5,5")//dashed array for line
        .style("stroke", '#100f')
        .style( 'stroke-width', '2px');
*/
        //add textfield
         g.selectAll("g")
         .data(massnahmen)
         .enter()
         .append("rect")
         .attr("class", "textBox")
         .attr("x", function(d) { return xScale(d.date) -40; })
         .attr("y", 450)
         .attr("width", 100)
         .attr("height", 100)
         .style('fill', "#40FF00")
         .attr('stroke', '#100f');

         g.selectAll("g")
            .data(massnahmen)
            .enter()
            .append('polygon')
            .attr("points", function(d) { 
                return ((xScale(d.date) - 10) + ', ' + 450 + ', '   //left point
                        + (xScale(d.date) + 30) +', ' + 450+ ', '   //right point
                        + (xScale(d.date) + 10) + ', ' + 420);      //top point
            })
            .style('fill', '#40FF00')
            .style("stroke", '#100f');

        //add line to cover black stroke of text box
        g.selectAll("g")
            .data(massnahmen)
            .enter()
            .append("line")
            .attr("x1", function(d) { return xScale(d.date) - 9.5; })
            .attr("x2", function(d) { return xScale(d.date) + 29.5; })
            .attr("y1", 450)
            .attr("y2", 450)
            .style('stroke', '#40FF00')
            .style( 'stroke-width', '2px');

        //add text
        g.selectAll("g")
            .data(massnahmen)
            .enter()
            .append("text")
            .attr("class", ".text")
            .attr("x", function(d) { return xScale(d.date) -35; })
            .attr("y", 475)
            .attr("dy", ".35em")
            .text(function(d) { return d.text; });


/*
         //add text boxes
         var massnahmenText = d3.select("body").append("div")   
            .attr("id", "massnahmen")               
            .data(massnahmen)
            .html(""+massnahmen.text+"")
            .style("left", margin + 0) 
            .style("top", 550 + "px")
            .style("color", "#333333");
*/
/*
        var xPol = d3.scaleLinear().range([0, 500]);
	    var yPol = d3.scaleLinear().range([500, 0]);
  
        xPol.domain([-100, 100]);
        yPol.domain([-100, 100]);
        var poly =  [{"x":15, "y":-20},
                    {"x":5,"y":-20},
                    {"x":5,"y":-0},
                    {"x":15,"y":-0}];

        svg.selectAll("polygon")
            .data([poly])
            .enter().append("polygon")
            .attr("points",function(d) { 
                return d.map(function(d) {
                            return [xPol(d.x),yPol(d.y)].join(",");
                        }).join(" ");
    });

        // add the X Axis
  svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(xPol))
    .attr("transform", "translate(" + 100 + "," + 500 + ")");

  // add the Y Axis
  svg.append("g")
    .call(d3.axisLeft(yPol))
    .attr("transform", "translate(" + 100 + "," + 100 + ")");
    */
        })
        
    }
update(february2019,february2020);

//add legend
var VALUES = ["month2019", "month2020"]

var legend = svg.selectAll(".legend")
    .data(VALUES)
    .enter()
    .append("g")

    legend.append("rect")
    .attr("fill", "#4391b5")
    .attr("width", 20)
    .attr("height", 20)
    .attr("y", 25)
    .attr("x", 600);
    legend.append("rect")
    .attr("fill", "#d2d2d2")
    .attr("width", 20)
    .attr("height", 20)
    .attr("y", 25)
    .attr("x", 680);

    legend.append("text")
    .attr("class", "label")
    .attr("y", 40)
    .attr("x", 630)
    .attr("text-anchor", "start")
    .text("2019");
    legend.append("text")
    .attr("class", "label")
    .attr("y", 40)
    .attr("x", 710)
    .attr("text-anchor", "start")
    .text("2020");
    
//add tooltip
var tooplTipDiv = d3.select("body").append("div")   
    .attr("id", "myTooltip")               
    .style("opacity", 0);

// tooltip function mouse over       
function onMouseOver(d){

    var tooltipDiv = d3.select("#myTooltip"); 

    //Get this bar's x/y values, then augment for the tooltip
    var xPosition = parseFloat(d3.select(this).attr("x")) + (xScale.bandwidth() / 2) +116;//+55;
	var yPosition = parseFloat(d3.select(this).attr("y"))+ 40;
    //tooltip position varies in relation to screen size

    tooltipDiv.transition()        
    .duration(200)      
    .style("opacity", 1);    

    tooltipDiv
    .html( "Fahrgäste: " + d.transported_people)
    .style("left", xPosition + "px") 
    .style("cursor", "pointer")
    .style("top", yPosition + "px")
    .style("color", "#333333");      
    
    d3.select(this)
        .style("opacity", 0.5);
}

function onMouseOut(d){
var tooltipDiv = d3.select("#myTooltip"); 
    tooltipDiv
    .transition()        
    .duration(500)      
    .style("opacity", 0); 

    d3.select(this)
        .style("opacity", 1)
}

</script>
</body>
</html>