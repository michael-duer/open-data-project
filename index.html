<!doctype html>
<html>
<head>
    <title>Home</title>
        <link rel="stylesheet" href="/stylesheet.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
      
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <!--<script src="/script.js"></script>-->
        
        <meta name="viewport" content="width=device-width, maximum-scale=0.5" />
    
    
<body>
    <!-- Background SVG not working
    <div class="background">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
            <path fill="#de2236" fill-opacity="1" d="M0,96L60,90.7C120,85,240,75,360,64C480,53,600,43,720,58.7C840,75,960,117,1080,122.7C1200,128,1320,96,1380,80L1440,64L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"></path>
        </svg>
    </div>
    -->
    <script>
    var january2019 = "./data/january2019.csv";
    var february2019 = "./data/february2019.csv";
    var march2019 = "./data/january2020.csv";
    var april2019 = "test2.csv";
    var may2019 = "test2.csv";
    var june2019 = "./data/january2019.csv";
    var july2019 = "test2.csv";
    var august2019 = "test2.csv";
    var september2019 = "test2.csv";
    var october2019 = "test2.csv";
    var november2019 = "test2.csv";
    var december2019 = "test2.csv";
    var year2019 = "./data/real-test.csv";

    var january2020 = "./data/january2020.csv";
    var february2020 = "./data/february2020.csv";
    var march2020 = "./data/january2020.csv";
    var april2020 = "test.csv";
    var may2020 = "test.csv";
    var june2020 = "./data/january2019.csv";
    var july2020 = "test.csv";
    var august2020 = "test.csv";
    var september2020 = "test.csv";
    var october2020 = "test.csv";
    var november2020 = "test.csv";
    var december2020 = "test.csv";
    var year2020 = "./data/real-test2.csv";
    </script>

<div class="visualisation">

    <svg id="bar-chart" width="1200" height="700"></svg>

    <div class="bttn-box">
        <div class="month-bttn">
            <button onclick="update(january2019,january2020)">Januar</button>
            <button onclick="update(february2019,february2020)">Februar</button>
            <button onclick="update(march2019,march2020)">März</button>
            <button onclick="update(april2019,april2020)">April</button>
            <button onclick="update(may2019,may2020)">Mai</button>
            <button onclick="update(june2019,june2020)">Juni</button>
            <button onclick="update(july2019,july2020)">Juli</button>
            <button onclick="update(august2019,august2020)">August</button>
            <button onclick="update(september2019,september2020)">September</button>
            <button onclick="update(october2019,october2020)">Oktober</button>
            <button onclick="update(november2019,november2020)">November</button>
            <button onclick="update(december2019,december2020)">Dezember</button>
        </div>
        <div class="year-bttn">
            <button onclick="update(year2019,year2020)">Gesammtjahresvergleich</button>
        </div>
    </div>
</div>
<script>
    
    var svg = d3.select("svg"),
        margin = 200,
        width = svg.attr("width") - margin,
        height = svg.attr("height") - margin -100

    svg.append("text")
       .attr("transform", "translate(100,0)")
       .attr("x", 50)
       .attr("y", 50)
       .attr("font-size", "30px")
       .text("Fahrgastzahlen")

       var g = svg.append("g")
               .attr("transform", "translate(" + 100 + "," + 100 + ")");

    //initialize X-axis
    var xScale = d3.scaleBand().range([0, width]).padding(0.4)

    var xAxis = svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(" + 100 + "," + 500 + ")");

    xAxis = d3.axisBottom()
    .scale(xScale);

    //initialize Y-axis
    var yScale = d3.scaleLinear().range([height, 0]);
    var yAxis = svg.append("g")
        .attr("class", "y axis");

    yAxis = d3.axisLeft(yScale);

// function to update the chart with new data
function update(month2019, month2020) {
    
    // Parse the Data
    d3.queue()
        .defer(d3.csv, month2019) //2019
        .defer(d3.csv, month2020) //2020
        .defer(d3.csv, "massnahmen.csv")
        .await(function(error, data2019, data2020, massnahmen) {
            if (error) throw error;   
    
    //parse date from csv data
    function parseDate(d) {
        var delimiter = d.split(".");
        var d1 = new Date(Number(delimiter[2]), Number(delimiter[1]) -1, Number(delimiter[0]));
        return d3.timeFormat("%d.%m")(d1)
        };
    var dateFromCsv = [];
    data2019.forEach(function(d) {
        d.date = parseDate(d.date);
        dateFromCsv.push(d.date);
        d.transported_people = +d.transported_people;
    });
    data2020.forEach(function(d) {
        d.date = parseDate(d.date);
        d.transported_people = +d.transported_people;
    });
    massnahmen.forEach(function(d) {
        d.date = parseDate(d.date);
        d.text = d.text;
    });

    // set axis domains
    xScale.domain(data2019.map(function(d) { return d.date; }));
  
    yScale.domain([0, d3.max(data2019, function(d) { return d.transported_people; })]);
     
    //update xAxis
    svg.select(".x.axis")
        .transition()
        .duration(1000)
        .call(xAxis)
        .call(d3.axisBottom(xScale));
/*            .tickFormat((d) => {
                var delimiter = d.split(".");
                var d1 = new Date(Number(delimiter[2]), Number(delimiter[1]) -1, Number(delimiter[0]));
                return d3.timeFormat("%d.%m")(d1)
                })); */

    //Update yAxis
    svg.select(".y.axis")
        .attr("transform", "translate(" + 100 + "," + 100 + ")")
        .transition()
        .duration(1000)
        .call(d3.axisLeft(yScale).tickFormat(function(d){
            return d;
        })
        .ticks(10))
        //delete y-axis
        .call(g => g.select(".domain")
        .remove());
    
      //delete old bars
      g.selectAll(".bar")
            .transition()
            .duration(500)
            .attr("y", 400)
            .attr("height", 0)
            .remove();

        //delete old circle             UNUSED
/*        g.selectAll("circle")
            .transition()
            .duration(500)
            .attr("r", 0)
            .remove();
*/    
        //delete old text
        g.selectAll("text")
            .remove();

        //delete textbox
        g.selectAll(".textBox")
            .transition()
            .duration(500)
            .attr("y", 800)
            .attr("height", 0)
            .remove();

        //delete old line from box to point
        g.selectAll("line")
            .remove();
        
        //delete polygon
        g.selectAll("polygon")
         //   .transition()
         //   .duration(500)
            .remove();
    
        // update bars2019
       g
        .selectAll("bar2019")
        .data(data2019)
        .enter()
        .append("rect")
        .on("mouseover", onMouseOver)                  
        .on("mouseout", onMouseOut)
        .attr("class", "bar")
        .attr("id", 'bar2019')
        .attr("y", height)
        .attr("x", function(d) { return xScale(d.date);})
        .attr("height", 0)
        .transition()
        .duration(1000)
        .attr("x", function(d) { return xScale(d.date); })
        .attr("y", function(d) { return yScale(d.transported_people); })
        .attr("width", xScale.bandwidth() -5)
        .attr("height", function(d) { return height - yScale(d.transported_people); });
    
        // update bars2020
        g
        .selectAll("bar2020")
        .data(data2020)
        .enter()
        .append("rect")
        .on("mouseover", onMouseOver)                  
        .on("mouseout", onMouseOut)
        .attr("class", "bar")
        .attr("id", 'bar2020')
        .attr("y", height)
        .attr("x", function(d) { return xScale(d.date);})
        .attr("height", 0)
        .transition()
        .duration(1000)
        .attr("x", function(d) { return xScale(d.date) + 10; })
        .attr("y", function(d) { return yScale(d.transported_people); })
        .attr("width", xScale.bandwidth() -5)
        .attr("height", function(d) { return height - yScale(d.transported_people); });
        

        //ersteut 2 kreise dr erst aus umrandig vom 2.
   /*     g.selectAll("g")
         .data(massnahmen)
         .enter().append("circle")
         .attr("class", "circle")
         .attr("r", 7)
         .attr("cx", function(d) { return xScale(d.date) + 10; })
         .attr("cy", 400)
         .style('fill', "#100f");

         g.selectAll("g")
         .data(massnahmen)
         .enter().append("circle")
         .attr("class", "circle")
         .attr("r", 6)
         .attr("cx", function(d) { return xScale(d.date) + 10; })
         .attr("cy", 400)
         .style('fill', "#ffff")
         .style('opacity', 1);

         g.append("line")//making a line for legend
        .data(massnahmen)
        .lower()
        .attr("x1", function(d) { return xScale(d.date) + 10; })
        .attr("x2", function(d) { return xScale(d.date) + 10; })
        .attr("y1", 400)
        .attr("y2", 450)
        .style("stroke-dasharray","5,5")//dashed array for line
        .style("stroke", '#100f')
        .style( 'stroke-width', '2px');
*/
        //add textfield
         g.selectAll("g")
         .data(massnahmen)
         .enter()
         .append("rect")
         .attr("class", "textBox")
         .attr("x", function(d) { 
             if (dateFromCsv.includes(d.date)) {
                return xScale(d.date) -40;
            } else {
                return 0;
            }})
         .attr("y", 450)
         .attr("width", 200)
         .attr("height", function(d) { 
             if (dateFromCsv.includes(d.date)) {
                 return 100; 
            } else {
                return 0;
            }})
         .style('fill', "#40FF00")
         .attr('stroke', '#100f');

         g.selectAll("g")
            .data(massnahmen)
            .enter()
            .append('polygon')
            .attr("points", function(d) { 
             if (dateFromCsv.includes(d.date)) {
                return ((xScale(d.date) - 10) + ', ' + 450 + ', '   //left point
                        + (xScale(d.date) + 30) +', ' + 450+ ', '   //right point
                        + (xScale(d.date) + 10) + ', ' + 420);      //top point 
            } else {
                return 0 + ', ' + 0 + ', ' + 0 + ', ' + 0 + ', ' + 0 + ', ' + 0;
            }})
            .style('fill', '#40FF00')
            .style("stroke", '#100f');

        //add line to cover black stroke of text box
        g.selectAll("g")
            .data(massnahmen)
            .enter()
            .append("line")
            .attr("x1", function(d) { 
             if (dateFromCsv.includes(d.date)) {
                return xScale(d.date) - 9.5; 
            } else {
                return 0;
            }})
            .attr("x2", function(d) { 
             if (dateFromCsv.includes(d.date)) {
                return xScale(d.date) + 29.5;
            } else {
                return 0;
            }})
            .attr("y1", 450)
            .attr("y2", 450)
            .style('stroke', '#40FF00')
            .style( 'stroke-width', '2px');

//add text
g.selectAll("g")
            .data(massnahmen)
            .enter()
            .append("text")
            .attr("class", ".text")
            .attr("class", "text")
            .attr("x", function(d) { 
             if (dateFromCsv.includes(d.date)) {
                return xScale(d.date) -35;
            } else {
                return;
            }})
            .attr("y", 475)
            .attr("dy", ".35em")
            .text(function(d) { 
             if (dateFromCsv.includes(d.date)) {
                 return d.text; 
            } else {
                return;
            }});


 /* try to wrap the text

    var long = 'This line should be about three to four^lines long, but because I am still^learning stuff, I cannot make it do^what I want it to do. Woe is me.'
    var short = long.split('^');
    console.log(short);
        //add text
        g.selectAll("g")
            .data(massnahmen)
            .enter()
            .append("text")
            .attr("class", "text")
            .attr("x", function(d) { return xScale(d.date) -35; })
            .attr("y", 475)
          //  .attr("dy", ".35em")
            .selectAll('tspan').data(short)
            .enter().append('tspan')
            .text(function(d) {
                    return d;
            })
            .attr("textLength", 200)
            .attr("lengthAdjust", "spacingAndGlyphs")
            .attr('dy', '1em')
            .attr('x', '150');
            */
        })

    }
update(february2019,february2020);

//add legend
var VALUES = ["month2019", "month2020"]

var legend = svg.selectAll(".legend")
    .data(VALUES)
    .enter()
    .append("g")

    legend.append("rect")
    .attr("fill", "#4682b4")
    .attr("width", 20)
    .attr("height", 20)
    .attr("y", 25)
    .attr("x", 600);
    legend.append("rect")
    .attr("fill", "#663399")
    .attr("width", 20)
    .attr("height", 20)
    .attr("y", 25)
    .attr("x", 680);

    legend.append("text")
    .attr("class", "label")
    .attr("y", 40)
    .attr("x", 630)
    .attr("text-anchor", "start")
    .text("2019");
    legend.append("text")
    .attr("class", "label")
    .attr("y", 40)
    .attr("x", 710)
    .attr("text-anchor", "start")
    .text("2020");
    
//add tooltip
var tooplTipDiv = d3.select("body").append("div")   
    .attr("id", "myTooltip")               
    .style("opacity", 0);

// tooltip function mouse over       
function onMouseOver(d){

    var tooltipDiv = d3.select("#myTooltip"); 

    //Get this bar's x/y values, then augment for the tooltip
    var xPosition = parseFloat(d3.select(this).attr("x")) + (xScale.bandwidth() / 2) +108;//+55;
	var yPosition = parseFloat(d3.select(this).attr("y"))+ 40;
    //tooltip position varies in relation to screen size

    tooltipDiv.transition()        
    .duration(200)      
    .style("opacity", 1);    

    tooltipDiv
    .html( "Fahrgäste: " + d.transported_people)
    .style("left", xPosition + "px") 
    .style("cursor", "pointer")
    .style("top", yPosition + "px")
    .style("color", "#333333");      
    
    d3.select(this)
        .style("opacity", 0.5);
}

function onMouseOut(d){
var tooltipDiv = d3.select("#myTooltip"); 
    tooltipDiv
    .transition()        
    .duration(500)      
    .style("opacity", 0); 

    d3.select(this)
        .style("opacity", 1)
}

</script>
</body>
</html>